-- Register the behaviour
behaviour("MoreWeatherEffects")

function MoreWeatherEffects:Start()
	-- Run when behaviour is created
	self.weatherSelected = self.script.mutator.GetConfigurationDropdown("weatherEffect")
	print("Dropdown selected: " .. tostring(self.script.mutator.GetConfigurationDropdown("weatherEffect")))
	self.levelOfQuality = self.script.mutator.GetConfigurationRange("qualityLevel")
	self.enableClouds = self.script.mutator.GetConfigurationBool("enableClouds")
	self.enableFog = self.script.mutator.GetConfigurationBool("realisticSandstorm")
	-- self.lightningFrequency = self.script.mutator.GetConfigurationRange("lightningFrequency") * 60
	self.enableRealisticClouds = self.script.mutator.GetConfigurationBool("realisticClouds")
	self.cloudHeightMethod = self.script.mutator.GetConfigurationDropdown("cloudHeightMethod")
	self.cloudsPrefab = self.targets.clouds
	GameEvents.onActorSpawn.AddListener(self,"onActorSpawn")
	self.audioPlayer = self.targets.audioPlayer
	self.instanceAudioPlayer = GameObject.Instantiate(self.audioPlayer)
	self.audioPlayerAll = self.instanceAudioPlayer.gameObject.GetComponentsInChildren(AudioSource)
	self.windHowl = self.audioPlayerAll[1]
	self.windAmbience = self.audioPlayerAll[2]
	self.rainDrops = self.audioPlayerAll[3]
	self.gentlerain = self.audioPlayerAll[4]
	if(self.cloudHeightMethod == 0) then
		local capturePoints = {}
		local heightAverage = 0
		for i,y in ipairs(ActorManager.capturePoints) do
			heightAverage = heightAverage + y.transform.position.y
		end
		heightAverage = heightAverage / self:tablelength(ActorManager.actors)
		self.cloudHeight = heightAverage + 233
		print("Cloud Height (avg): " .. tostring(self.cloudHeight))
	else if(self.cloudHeightMethod == 1) then
		local highestCapturePoint = {}
		for i,y in ipairs(ActorManager.capturePoints) do
			table.insert(highestCapturePoint, y.transform.position.y)
		end
		-- Maybe getting the average would be the best solution
		table.sort(highestCapturePoint, function(a, b) return a > b end)
		print("Cloud Height (highest Point): " .. tostring(highestCapturePoint[1] + 233) )
	end
	end
	
	self.disableBecauseSeated = false
	self.startedWithOnlyClouds = false
	if(self.levelOfQuality == 1) then
		self.psFog = self.targets.FogPs1
	else if self.levelOfQuality == 2 then
		self.psFog = self.targets.FogPs2
	else if self.levelOfQuality == 3 then
		self.psFog = self.targets.FogPs3
	else if self.levelOfQuality == 4 then
		self.psFog = self.targets.FogPs4
	end
	end
	end
	end
	if(self.levelOfQuality == 1) then
		self.psSnow = self.targets.SnowPs1
	else if self.levelOfQuality == 2 then
		self.psSnow = self.targets.SnowPs2
	else if self.levelOfQuality == 3 then
		self.psSnow = self.targets.SnowPs3
	else if self.levelOfQuality == 4 then
		self.psSnow = self.targets.SnowPs4
	end
	end
	end
	end
	if(self.levelOfQuality == 1) then
		self.psSandstorm = self.targets.sandstormPs1
	else if self.levelOfQuality == 2 then
		self.psSandstorm = self.targets.sandstormPs2
	else if self.levelOfQuality == 3 then
		self.psSandstorm = self.targets.sandstormPs3
	else if self.levelOfQuality == 4 then
		self.psSandstorm = self.targets.sandstormPs4
	end
	end
	end
	end
	if(self.levelOfQuality == 1) then
		self.psRain = self.targets.rainPs1
	else if self.levelOfQuality == 2 then
		self.psRain = self.targets.rainPs2
	else if self.levelOfQuality == 3 then
		self.psRain = self.targets.rainPs3
	else if self.levelOfQuality == 4 then
		self.psRain = self.targets.rainPs4
	end
	end
	end
	end
	self.headingPos = Vector3.zero
	self.lead = true
	self.onlyClouds = false
	-- self.psRain = self.targets.RainPs
	-- self.psHRain = self.targets.HRainPs
	self.speed = 1
	self.speedV = 1
	self.leadAhead = 1
	self.playerPressedF8 = false
	-- self.lightningRange = {80, 2 * 60} 
	self.lightningAudioScaler = {}
	self.lightningRange = {self.lightningFrequency, self.lightningFrequency + 5} 
	-- self.psExp = self.targets.Exp
	self.currentOffset = Vector3(0,0,0)
	self.currentVehicleOffset = Vector3(0,0,0)
	if(self.weatherSelected == 0) then -- Snow
		self.lead = true
		self.currentPs = GameObject.Instantiate(self.psSnow)	
		self.currentOffset = Vector3(0,4.5,0)
		self.speed = 0.86
		self.speedV = 1.2
		self.leadAhead = 0.8
		self.currentVehicleOffset = Vector3(0,2.5,0)
	else if self.weatherSelected == 1 then -- Sandstorm
		self.currentPs = GameObject.Instantiate(self.psSandstorm)
		self.currentOffset = Vector3(0,0.05,0)
		self.speed = 1
		self.speedV = 1.3
		self.leadAhead = 1.4
		self.lead = true	
		if(self.enableFog == true) then
		self.script.StartCoroutine(self:ApplyRenderSettings(0.01,30.02,297.5,Color(238/255,232/255,205/255,0.2)))
		end
		self.windAmbience.Play()
		self.windHowl.Play()
		self.currentVehicleOffset = Vector3(0,2.5,0)
	else if self.weatherSelected == 2 then -- Rain
		
		self.currentPs = GameObject.Instantiate(self.psRain)
		self.lead = true
		self.currentOffset = Vector3(0,-1,0)
		self.speed = 1
		self.speedV = 1.5
		self.leadAhead = 1.6
		self.windAmbience.Play()
		self.windHowl.Play()
		self.currentVehicleOffset = Vector3(0,25,0)
	else if self.weatherSelected == 3 then -- Fog
		self.currentPs = GameObject.Instantiate(self.psFog)	
		self.currentOffset = Vector3(0,0.05,0)
		self.speed = 1.2
		self.speedV = 1
		self.leadAhead = 3.2
		self.lead = true
		self.currentVehicleOffset = Vector3(0,0,0) 
		if(self.enableFog == true) then
		self.script.StartCoroutine(self:ApplyRenderSettings(0.002,30,400,Color(0.79,0.79,0.79,0.2)))
		end
	else if self.weatherSelected == 4 then
		self.enableClouds = true
		self.onlyClouds = true
		self.startedWithOnlyClouds = true
	else if self.weatherSelected == 5 then
		self.enableClouds = true
		self.onlyClouds = true
		self.startedWithOnlyClouds = true
		self.script.StartCoroutine(self:RandomLightningStrike(Random.Range(self.lightningRange[1],self.lightningRange[2])))
	end
	end
	end	
end
end
end
if(self.enableClouds) then
if(self.weatherSelected ~= 2) then
	if(self.weatherSelected ~= 5) then
	if(self.enableRealisticClouds) then
		self.cloudsPs = GameObject.Instantiate(self.targets.cloudRealistic)
	else
		self.cloudsPs = GameObject.Instantiate(self.cloudsPrefab)
	end
else
	if(self.enableRealisticClouds) then
		self.cloudsPs = GameObject.Instantiate(self.targets.cloudRainRealistic)
	else
		self.cloudsPs = GameObject.Instantiate(self.cloudsRain)
	end
	end
else if self.weatherSelected == 2 then
	if(self.enableRealisticClouds) then
		self.cloudsPs = GameObject.Instantiate(self.targets.cloudRainRealistic)
	else
		self.cloudsPs = GameObject.Instantiate(self.targets.cloudsRain)
	end
end
end
end
if(self.currentPs ~= nil) then
	print(tostring(self.currentPs.gameObject.name))
end

end
function MoreWeatherEffects:tablelength(T)
	local count = 0
	for _ in pairs(T) do count = count + 1 end
	return count
end
function MoreWeatherEffects:onActorSpawn(actor)
if(not actor.isBot) then
self.script.StartCoroutine("ActorSpawn")
end
end
function MoreWeatherEffects:DestroyWithDelay(gameObject,delay)

	return function()
		coroutine.yield(WaitForSeconds(delay))
		local destroyGO = gameObject.gameObject
		if destroyGO == nil then
			return
		end
		GameObject.Destroy(destroyGO)
	end

end
function MoreWeatherEffects:tablefind(tab,el) -- Because Lua sucks
    for index, value in pairs(tab) do
        if value == el then
            return index
        end
    end
end
function MoreWeatherEffects:DestroyWithDelayLightning(gameObject,delay)

	return function()
		coroutine.yield(WaitForSeconds(delay))
		local destroyGO = gameObject.gameObject
		if destroyGO == nil then
			return
		end
		GameObject.Destroy(destroyGO)
		table.remove(self.lightningAudioScaler,self:tablefind(self.lightningAudioScaler,gameObject))

	end

end
function MoreWeatherEffects:ActorSpawn()

coroutine.yield(WaitForSeconds(0.1))
if(not self.onlyClouds or not self.startedWithOnlyClouds) then
self.currentPs.transform.position = Player.actor.position
end
end
function MoreWeatherEffects:PlayRealisticLightningAudio(position)
return function()
local distance = Vector3.Distance(PlayerCamera.activeCamera.main.transform.position,position)
local soundGo = GameObject.Instantiate(self.targets.lightningSound)
soundGo.transform.position = position
local audioSource = soundGo.GetComponent(AudioSource)
table.insert(self.lightningAudioScaler,audioSource)
print("distance " .. tostring(distance))
local normalizedAudio =  1 - (distance / (800))
print("Normalized audio " .. tostring(normalizedAudio))
audioSource.volume = normalizedAudio
print("Without 1+normalizedAudio" .. tostring((distance / 350)))
print("With 1-normalizedAudio" .. tostring((distance / 350) * (1-normalizedAudio)))
coroutine.yield(WaitForSeconds((distance / 350) * (1-normalizedAudio))) -- Value not accurate at all
-- I forgot why I didn't just parent the audio to the lightning
audioSource.Play()
self.script.StartCoroutine(self:DestroyWithDelayLightning(soundGo,7))
end
end
function MoreWeatherEffects:RandomLightningStrike(delay)
return function()
	coroutine.yield(WaitForSeconds(delay))
	local lightningStrikeObj = GameObject.Instantiate(self.targets.Lightning)
	local allActors = {}
	for i,y in ipairs(ActorManager.actors) do
		if(not y.isDead and y.isBot and y.team == Player.enemyTeam) then
		table.insert(allActors, y)
		end
	end
	if(self:tablelength(allActors) == 0) then
		coroutine.yield(WaitForSeconds(5))
		self.script.StartCoroutine(self:RandomLightningStrike(Random.Range(self.lightningRange[1],self.lightningRange[2])))
		return
	end
	local actor = allActors[Random.Range(1,self:tablelength(allActors))].transform.position
	lightningStrikeObj.transform.position = actor
	lightningStrikeObj.GetComponent(ParticleSystem).Play(true)
	local lightningStrikeImpact = GameObject.Instantiate(self.targets.lightningExplosion)
	lightningStrikeImpact.transform.position = actor + Vector3(0,2,0)
	self.script.StartCoroutine(self:PlayRealisticLightningAudio(lightningStrikeObj.transform.position))
	self.script.StartCoroutine(self:DestroyWithDelay(lightningStrikeObj,12))
	for k in pairs (allActors) do
		allActors[k] = nil
	end
	coroutine.yield(WaitForSeconds(1))
	self.script.StartCoroutine(self:RandomLightningStrike(Random.Range(self.lightningRange[1],self.lightningRange[2])))
end
end

function MoreWeatherEffects:ApplyRenderSettings(fogDensitiy,startDis,endDis,color)
	return function()
	coroutine.yield(WaitForSeconds(1))
	RenderSettings.fog = true
	RenderSettings.fogColor = color
	RenderSettings.fogDensity = fogDensitiy
	RenderSettings.fogStartDistance = startDis 
	RenderSettings.fogEndDistance = endDis
	end
end
function MoreWeatherEffects:SetAudioSourceVolume(index,volume)
	self.audioPlayerAll[index].volume = volume
end
function MoreWeatherEffects:PlayAll()
for i,y in ipairs(self.audioPlayerAll) do
	if(not y.isPlaying) then
	y.Play()
	end
end
end
function MoreWeatherEffects:StopAll()
	for i,y in ipairs(self.audioPlayerAll) do
		if(y.isPlaying) then
		y.Stop()
		end
	end
end
function MoreWeatherEffects:Update()
	if(GameManager.isPaused) then
		self.windHowl.Stop()
		self.windAmbience.Stop()
		self.rainDrops.Stop()
		self.gentlerain.Stop()
	else
		if(not self.rainDrops.isPlaying and self.weatherSelected == 2) then
			self.rainDrops.Play()
			self.gentlerain.Play()
			self.windAmbience.Play()
		end
		if(not self.windAmbience.isPlaying and self.weatherSelected == 1) then
			self.windHowl.Play()
			self.windAmbience.Play()
		end
	end

	if PlayerCamera.activeCamera.main ~= nil or PlayerCamera.activeCamera ~= nil and self.currentPs ~= nil and Player.actor ~= nil then
		for i,y in ipairs(self.lightningAudioScaler) do
			if(y ~= nil) then
			y.pitch = Time.timeScale
			end
		end
		self.windAmbience.pitch = Time.timeScale
		self.windHowl.pitch = Time.timeScale
		self.rainDrops.pitch = Time.timeScale
		self.gentlerain.pitch = Time.timeScale
		self.instanceAudioPlayer.transform.position = PlayerCamera.activeCamera.transform.position
		if(not self.startedWithOnlyClouds) then
			if(Player.actor.isSeated and self.weatherSelected == 1) then
				if(Player.actor.activeVehicle.isAircraft) then
				if(self.currentPs.GetComponent(ParticleSystem).isPlaying) then
					self.currentPs.GetComponent(ParticleSystem).Stop(true)
					self.onlyClouds = true
					self.disableBecauseSeated = true
				
				end
			else
					self.disableBecauseSeated = false
					self.onlyClouds = false
				end
			end
		if(self.cloudHeight < (Player.actor.position.y - 2) and not self.startedWithOnlyClouds ) then
			if(self.currentPs.GetComponent(ParticleSystem).isPlaying) then
				self.currentPs.GetComponent(ParticleSystem).Stop(true)
				self.onlyClouds = true
				
			end
		else if not self.disableBecauseSeated and self.cloudHeight > (Player.actor.position.y - 2) then
			self.onlyClouds = false
		end
		end
		end
		if(not self.onlyClouds or not self.startedWithOnlyClouds) then -- start onlyClouds

		local ray = Ray(PlayerCamera.activeCamera.transform.position + PlayerCamera.activeCamera.transform.forward, PlayerCamera.activeCamera.transform.up)
		local raycast = Physics.Raycast(ray,9, RaycastTarget.Default)
		if raycast ~= nil then -- start raycast ~= nil 
			if(raycast.transform.gameObject.GetComponent(Vehicle) == nil) then
				self.headingPos = Vector3.Lerp(self.headingPos,Player.actor.velocity,Time.deltaTime * 1.2)
				if(not GameManager.isPaused and self.weatherSelected == 1 or self.weatherSelected == 2) then
					self.windAmbience.volume = Mathf.Lerp(self.windAmbience.volume,0.1,Time.deltaTime * 0.7)
					self.windHowl.volume = Mathf.Lerp(self.windHowl.volume,0.2,Time.deltaTime * 0.7)
					self.rainDrops.volume = Mathf.Lerp(self.rainDrops.volume,0.2,Time.deltaTime * 0.7)
				end
				if(self.currentPs.GetComponent(ParticleSystem).isPlaying) then
					self.currentPs.GetComponent(ParticleSystem).Stop(true)
				end
				end
		else -- else raycast ~= nil 
			if(not self.currentPs.GetComponent(ParticleSystem).isPlaying) then
				self.currentPs.GetComponent(ParticleSystem).Play(true)
			end
			if(not GameManager.isPaused and self.weatherSelected == 1 or self.weatherSelected == 2 and not Player.actor.isSeated) then
			self.windAmbience.volume = Mathf.Lerp(self.windAmbience.volume,0.6,Time.deltaTime * 0.7)
			self.windHowl.volume = Mathf.Lerp(self.windHowl.volume,0.7,Time.deltaTime * 0.7)
			self.rainDrops.volume  = Mathf.Lerp(self.rainDrops.volume,0.7,Time.deltaTime * 1)
			self.gentlerain.volume  = Mathf.Lerp(self.gentlerain.volume,1,Time.deltaTime * 1)
			else if not GameManager.isPaused and self.weatherSelected == 1 or self.weatherSelected == 2 and Player.actor.isSeated then
			self.windAmbience.volume = Mathf.Lerp(self.windAmbience.volume,0.36,Time.deltaTime * 0.7)
			self.windHowl.volume = Mathf.Lerp(self.windHowl.volume,0.3,Time.deltaTime * 0.7)
			self.rainDrops.volume = Mathf.Lerp(self.rainDrops.volume,0.3,Time.deltaTime * 1)
			self.gentlerain.volume = Mathf.Lerp(self.gentlerain.volume,0.2,Time.deltaTime * 1)	
			end
			end
			self.headingPos =  Player.actor.velocity
		end  -- end raycast ~= nil 
		end-- end onlyClouds
		if(not Player.actor.isSeated) then
			-- Start Cloud
				if(self.enableClouds) then
					self.cloudsPs.transform.position = Vector3.Lerp(self.cloudsPs.transform.position,Vector3(Player.actor.velocity.x,0,Player.actor.velocity.z) + Vector3(Player.actor.position.x,self.cloudHeight,Player.actor.position.z) ,Time.fixedDeltaTime * 1.4) 
				end
			-- End Cloud
				if(not self.onlyClouds and not self.startedWithOnlyClouds) then
					if(self.lead) then
					self.currentPs.transform.position = Vector3.Lerp(self.currentPs.transform.position,(self.headingPos * self.leadAhead) + Player.actor.position + self.currentOffset,Time.fixedDeltaTime * self.speed) 
				else
					self.currentPs.transform.position = Player.actor.position
			end
			end
			else
			-- Start Cloud
				if(self.enableClouds) then
					self.cloudsPs.transform.position = Vector3.Lerp(self.cloudsPs.transform.position,Vector3(Player.actor.velocity.x,0,Player.actor.velocity.z) + Vector3(Player.actor.position.x,self.cloudHeight,Player.actor.position.z) ,Time.fixedDeltaTime * 1.4) 
				end
			-- End Cloud
				if(not self.onlyClouds and not self.startedWithOnlyClouds) then
					if(self.lead) then
						self.currentPs.transform.position = Vector3.Lerp(self.currentPs.transform.position,(self.headingPos) + Player.actor.position - self.currentVehicleOffset,Time.fixedDeltaTime * self.speedV) 
					else
						self.currentPs.transform.position = Player.actor.position
					end 
				end
		end
end
	
end
